# Section 2: AWS・DB設計 教材リファレンス

## Section 2-1: AWS基礎（オンプレミス・クラウド・AWS）

### レッスン内容

- オンプレミスとは
- クラウドとは
- オンプレとクラウドについて
- AWSについて
- AWSの代表的なサービス

### 課題

- S3を使って静的サイトを公開する
- CloudFrontを設定する

---

### オンプレミスとは

サーバーの筐体設置やシステムの構築・運用を自社で全て行う形態のこと。「オンプレ」と略される。

#### メリット

- **コントロールできる範囲が広い**: 機材の調達や設置、セキュリティ要件まで、システム以外の部分も自社の基準に沿って扱うことが可能
- **システムの自由度が高い**: クラウドサービスでは提供されていない機能やマシン性能も自社の要件に合わせて構築可能
- **拡張性が高い**: 複数拠点のデータセンターや、クラウドとオンプレのハイブリッド構成などアーキテクチャの拡張性が高い
- **コスト削減努力が可能**: クラウドでは利用料を自社で決められないが、オンプレだと調達・運用フェーズでコストを削減することが可能

#### デメリット

- **初期コストがかかる**: オンプレのメリットを最大限活かすためには、ルーター、ファイアーウォール、スイッチ、ラック、温度、電源管理などさまざまな機器が必要
- **メンテナンスが大変**: LANケーブルから各種ハードウェア、OS、ミドルウェアまでを全て管理し、セキュリティアップデートをかけていく必要がある

---

### クラウドとは

インターネット上の仮想空間の必要な部分だけを利用して、ITシステムを構築・運営を行う形態のこと。

#### メリット

- 使った分だけ料金を支払う形態が多いので、初期コストがかからない
- クラウド自体に障害が起きた時に自社で対応する必要がない（ハードウェアの管理が不要）
- 必要に応じてリソースの増減を行うことができる
- 短期間で新しいリソースの利用ができる
- デプロイが簡単
- クラウドベンダーが大規模な資金・リソースを投入しているため、1企業のオンプレではできないセキュリティ、品質の担保、サポート等を行ってくれる
- クラウドは世界中のサービスが利用しているため、リソースの集積率が高く、同一機能をオンプレとクラウドで利用する場合のコストがクラウドの方が安い

#### デメリット

- オンプレに比べると自由度は下がる
- クラウド自体に障害が発生した場合は、復旧まで何もすることができない

#### クラウドを使うときの注意点

- アクセスキーやトークンの漏洩に注意
- 安全なアクセス手段でアクセスし上手に使う

---

### オンプレとクラウドについて

- クラウドの方が良く聞こえるかもしれないが、必ずしもそうではない
- オンプレの最大のメリットは「自由度が高い」こと。お金次第でパフォーマンスは無限大
- オンプレとクラウドのメリット・デメリットを理解して組み合わせたハイブリッド環境もあり
- エンジニア市場では、クラウドの方が求人数が多い傾向

---

### AWSについて

Amazon Web Servicesの略で、世界で最も包括的で広く採用されているクラウドプラットフォーム。世界中のデータセンターから200以上のフル機能のサービスを提供している。

参考: [AWS とは](https://aws.amazon.com/jp/what-is-aws/)

#### AWSの主要なユースケース

- 仮想プライベートネットワークの作成・管理
- ドメイン管理
- IaaS, PaaS の利用
- コンテナオーケストレーションの利用
- オブジェクトベースのストレージ
- CDN の利用
- データベースの利用
- 認証基盤の利用
- 運用監視サービスの利用
- DevOps 関連サービス

#### AWSについて知りたい時に見るおすすめリンク

- [AWSサービス別資料](https://aws.amazon.com/jp/aws-jp-introduction/aws-jp-webinar-service-cut/)
- [AWSハンズオン資料](https://aws.amazon.com/jp/aws-jp-introduction/aws-jp-webinar-hands-on/)
- [AWSドキュメントページ](https://docs.aws.amazon.com/index.html)

---

### AWSの代表的なサービス

| サービス | 説明 |
|---------|------|
| **EC2** | 仮想サーバーを作成・利用できるサービス。必要に応じてスペックを変更できる |
| **S3** | オンラインストレージサービス。静的なコンテンツを配信できる。保存できる容量やファイル数に制限がない |
| **RDS** | データベースサービス。画面上で主要なデータベースを簡単に作成できる |
| **ECS** | コンテナ化されたアプリをデプロイ、管理、スケーリングするサービス |

---

### 課題（Must）

#### S3を使って静的サイトを公開

- HTMLファイルを準備する
- 下記の要件を満たす静的ページを作成する（できれば）:
  - ページの左側に項目があり、クリックすると右側に内容が表示される
  - 左側の項目は最低3つ作成する
- S3のドキュメントを参照して、作成した静的ページを公開する
  - 参考: [S3での静的ウェブサイトホスティング](https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/userguide/HostingWebsiteOnS3Setup.html)

#### CloudFrontを設定

- CloudFront（AWSのCDNサービス）を設定する
- 世界中に張り巡らされた配信ネットワークを利用して、ユーザーに効率的かつ高速にWebコンテンツを配信する仕組み
- 参考: [CloudFront](https://aws.amazon.com/jp/cloudfront/)
- 注意: CloudFront作成時にWAF（Web Application Firewall）が一緒に構築されてしまうことがあるので、作らない（できてしまったら削除する）

#### 補足リンク

- [ざっくりAWS（料金概算）](https://aws-rough.cc/)
- [AWS使用状況レポート](https://console.aws.amazon.com/billing/home#/)

---

### 課題提出

- 提出は任意
- 提出する場合はパブリックIPやスクリーンショットを共有
- レビュー完了後はAWS上のリソースを全て停止すること

---

## Section 2-2, 2-3

（GitHubに提出しないためスキップ）

---

## Section 2-4: なし

（欠番）

---

## Section 2-5: データベース・正規化・ER図

### レッスン内容

- データベース
- 正規化
- ER図

### 課題

- 要件に合うER図を作成する
- データを正規化する

---

### データベース

特定のデータを収集し、使いやすい形に格納した情報群のこと。データを活用するためにはシステムと結びつける必要があり、その役割を行っているのがデータベース。

#### リレーショナルデータベース（RDB）

データを表形式で管理し、複数の表（テーブル）が関係しあっているデータベースのこと。

#### テーブル

データベース内でデータを格納する領域。

基本的な構成要素:

| 用語 | 説明 |
|------|------|
| **カラム** | テーブルの「列」。情報の項目 |
| **レコード** | テーブルの「行」。情報を持ったデータが登録されていく |
| **フィールド** | 行と列が交差した部分。データを格納する |

---

### 正規化

データの重複をなくし、整合的にデータを取り扱えるようにデータベース設計すること。レコードに変更があった際になるべく更新するレコード数を減らすことで、メンテナンスの効率を高めることができる。

#### 正規化の例: クッキー注文テーブル

**正規化前（1テーブル）:**

| 注文番号 | 注文ユーザー番号 | ユーザー名 | ユーザーの電話番号 | 頼んだクッキーの番号 | クッキーの味 | 頼んだクッキーの数 | クッキーのブランド番号 | クッキーのブランド名 |
|---------|----------------|----------|-----------------|-------------------|------------|-----------------|--------------------|--------------------|
| 123 | 1 | Tanaka | 08012345678 | 111 | チョコ | 2 | 1111 | ステラ |
| 124 | 2 | Takahashi | 09098765432 | 222 | いちご | 3 | 2222 | ポール & ジョー |
| 125 | 3 | Suzuki | 07056563434 | 333 | キャラメル | 1 | 3333 | アンリ・シャルパンティエ |

**正規化後（4テーブル）:**

**注文テーブル:**

| 注文番号 | 頼んだクッキーの番号 | 頼んだクッキーの数 | 頼んだユーザー番号 |
|---------|-------------------|-----------------|-----------------|
| 123 | 111 | 2 | 1 |
| 124 | 222 | 3 | 2 |
| 125 | 333 | 1 | 3 |

**ユーザーテーブル:**

| ユーザー番号 | ユーザー名 | ユーザーの電話番号 |
|------------|----------|-----------------|
| 1 | ... | 08012345678 |
| 2 | ... | 09098765432 |
| 3 | ... | 07056563434 |

**クッキー情報テーブル:**

| クッキーの番号 | クッキーの味 | クッキーのブランド番号 |
|-------------|------------|--------------------|
| 111 | チョコ | 1111 |
| 222 | いちご | 2222 |
| 333 | キャラメル | 3333 |

**クッキーブランドテーブル:**

| クッキーのブランド番号 | クッキーのブランド名 |
|--------------------|--------------------|
| 1111 | ステラ |
| 2222 | ポール & ジョー |
| 3333 | アンリ・シャルパンティエ |

---

### ER図

- データベースの設計図
- データ間の関連や処理構造を可視化したもの

#### ER図作成ツール

- [draw.io](https://www.draw.io/)
- [drawSQL](https://drawsql.app/)

---

### 課題（Must）

#### 1. 旅行予約テーブルの正規化とER図作成

正規化前のテーブル:

| 予約番号 | 予約ユーザー番号 | ユーザー名 | ユーザータイプ番号 | ユーザータイプ | チェックイン日 | チェックアウト日 | 決済番号 | 決済タイプ | 決済ステータス | ホテル番号 | ホテル名 |
|---------|----------------|----------|-----------------|-------------|-------------|--------------|---------|----------|-------------|---------|---------|
| 1 | 1 | Tanaka | 1 | ゲスト | 2022/7/12 | 2022/7/14 | 100 | クレジットカード | 完了 | 11 | ヒルトン |
| 2 | 2 | Takahashi | 2 | 会員 | 2022/8/16 | 2022/7/18 | 101 | 現地 | 未完了 | 22 | マリオット |
| 3 | 3 | Suzuki | 1 | ゲスト | 2022/9/1 | 2022/9/5 | 102 | 現地 | 未完了 | 33 | ミラコスタ |

#### 2. つぶやきテーブルの正規化とER図作成

正規化前のテーブル:

| 呟き番号 | 呟いたユーザー番号 | ユーザー名 | ユーザーメールアドレス | ユーザーフォロー数 | ユーザーフォロワー数 | 呟き | 呟いた日時 | いいね数 |
|---------|-----------------|----------|--------------------|-----------------|--------------------|-----|----------|---------|
| 1 | 1 | Tanaka | tanaka@mse.com | 500 | 5000 | やるか！超やるか！！ | 2022/7/12 12:00 | 15 |
| 2 | 2 | Takahashi | takahashi@mse.com | 100 | 2000 | モンブラン美味しい | 2022/8/16 8:20 | 120 |
| 3 | 3 | Suzuki | suzuki@mse.com | 300 | 1000 | バおわ | 2022/9/1 22:45 | 10 |

#### 3. 正規化したテーブルに必要な情報を追加・パターン分け

旅行予約テーブルの場合の考慮点:
- ゲストと会員で予約フローは同じか？
- 旅行にキャンセルが出た場合は？
- クーポンや値引きキャンペーンはあるか？

つぶやきテーブルの場合の考慮点:
- フォローフォロワーのユーザー情報
- コメント機能
- DM機能

### 課題（Advanced）

#### 家計簿アプリのER図作成

- 最低限下記のテーブルを作成:
  - 入出金（入金も出金も同じテーブル）
  - カテゴリ（家賃・光熱費・交際費など）
- 各テーブルの項目は世の中の家計簿アプリを参考に設計
- 余力がある場合の追加条件:
  - 月ごとの集計結果を管理できるように（集計結果のキャッシュとして利用）
  - 複数ユーザの使用を前提にしたテーブル構成
- ※ Section 3, Section 4 でこのER図を利用する

---

### 課題提出

- ER図の画像ファイルをGitHubにpush
- PRを作成して提出（mainブランチからfeature/erブランチを作成、マージはしない）

---

## Section 2-6: RDB・NoSQL・SQL

### レッスン内容

- リレーショナルデータベース
- 非リレーショナルデータベース（NoSQLデータベース）
- SQL

### 課題

- SQLを使って実際にデータベースをローカルで作成し、データ操作をする

---

### リレーショナルデータベース（RDB）

データを表形式で管理し、複数の表（テーブル）が関係しあっているデータベース。データの一貫性を担保し検索性が高い。

#### 特徴

- 複雑なデータの関連性を扱えるようにしている
- テーブルとテーブルとの関係を定義することでデータを管理する
- 列と行で構成されている（列に重複しない項目を設定し、行にデータを入れていく）

#### 主なリレーショナルデータベース

- Oracle
- MySQL
- PostgreSQL

#### カラムのデータ型

データベースのカラムにはデータ型を設定する必要があり、設定したデータ型以外の値は保存できない。

主なデータ型:
- **数値型**: 整数型、ブーリアン型、小数点型
- **日付型・時間型**
- **文字列型**

#### 用語

| 用語 | 説明 |
|------|------|
| **プライマリーキー** | 各テーブルとデータを結びつける時に利用するもの。テーブル内で重複してはいけない |
| **ビュー** | 1つ以上のテーブルから必要な要素だけを取り出して作った仮想的なテーブル |
| **インデックス** | 目的のデータを取得するための索引のようなもの。データ量が多い場合に効率的にデータを探すことができる |

---

### 非リレーショナルデータベース（NoSQLデータベース）

リレーショナルデータベース以外のデータベースの総称。処理速度が速く、ビッグデータや大容量データでも高速に処理できる。

#### 特徴

- リレーショナルデータベースでは実現しづらい大規模な処理や柔軟なデータ構造が可能
- 比較的大規模なシステムで使われることが多い

#### NoSQLの種類

| 種類 | 特徴 | 主なDB |
|------|------|--------|
| **キーバリュー型** | キーとバリューの組み合わせで作られるシンプルなデータモデル。バリューとキーは1対1 | DynamoDB, Redis |
| **カラム指向型** | 行と列の概念を持たせたデータモデル。Row Keyで複数のKey Valueをグループ化している | HBase, Cassandra |
| **ドキュメント型** | JSONやXMLなどのデータ形式でデータを管理。ドキュメントに階層構造を持たせずに管理できる | MongoDB, CouchDB |

---

### SQL

データベースに対して命令を出す言語のこと。データベースの定義や操作を行う。

#### データ定義言語（DDL）

テーブルなどを作成、削除、変更するための命令文。

| コマンド | 説明 |
|---------|------|
| `CREATE` | テーブルの作成 |
| `ALTER` | テーブルの設定変更 |
| `DROP` | テーブルの削除 |
| `TRUNCATE` | テーブルデータの削除 |

#### データ操作言語（DML）

データベースに対してデータを追加、削除、更新などをする命令文。

| コマンド | 説明 |
|---------|------|
| `SELECT` | データの検索 |
| `INSERT` | データの追加 |
| `UPDATE` | データの更新 |
| `DELETE` | データの削除 |

#### データ制御言語（DCL）

データアクセス権を付与する命令文。

| コマンド | 説明 |
|---------|------|
| `GRANT` | 権限の付与 |
| `REVOKE` | 権限の取り消し |

#### 基本的なSQL構文

```sql
-- 特定のカラムのデータを取得する
SELECT カラム名 FROM テーブル名

-- 条件をつけてデータを取得する
SELECT カラム名 FROM テーブル名 WHERE 条件
```

---

### 課題（Must①）

#### 1. データベース・テーブル作成

- Section 2-5で正規化した旅行予約テーブル・つぶやきテーブルのデータベースを作成する
- ローカルのDB環境はDockerで構築する

**docker-compose.yml:**

```yaml
version: "3"
services:
  db:
    image: mysql:5.7
    restart: always
    platform: linux/x86_64
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: bluegold
      MYSQL_USER: admin
      MYSQL_PASSWORD: password
    volumes:
      - mysql_data:/var/lib/mysql
volumes:
  mysql_data:
```

- 構築後のデータベースへの接続はCUI/GUI（Workbench等）どちらでも可

#### 2. データの操作

- 作成したテーブルにデータを流し込む（`CREATE`, `ALTER`, `DROP`, `TRUNCATE`）
- SQLでデータを操作する（`SELECT`, `INSERT`, `UPDATE`, `DELETE`）
- 実際にこのデータベースが使われる場合に必要なデータの取得・更新・削除を実施し、それぞれの使用用途を記載する

### 課題（Must②）

#### データを効率よく取得する

提供されるzipファイルのREADMEを参考に環境構築し、以下を実施する。

1. データベースのER図を作成する
2. 以下のデータを取得するSQLを作成する:

**2-1. Customer Serviceの全社員情報取得**

取得する情報: 社員ID、社員誕生日、社員フルネーム、社員性別、所属部署。所属社員数も求める。

**2-2. 全社員情報取得**

取得する情報: 社員ID、社員誕生日、社員フルネーム（1カラム）、所属部署名、役割・階級、給料、上司のフルネーム（1カラム）。

ルール: 10秒前後で取得できることを目指す。

---

### 課題提出

- 基本不要
- 提出する場合は `.sql` ファイルに実行したSQLを記載してGitHubにpush
- PRを作成して提出（mainブランチからfeature/sqlブランチを作成、マージはしない）
